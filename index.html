<!DOCTYPE html>
<html lang="fr">
<head>
  <!-- SERIAL: v20240518-28 -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Damien GUESDON - CV</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700" rel="stylesheet" />
  <style>
    :root {
      --bg-light: #f7f9fb;
      --bg-dark: #181a1b;
      --text-light: #222;
      --text-dark: #f1f1f1;
      --container-light: #fff;
      --container-dark: #23272a;
      --primary-light: #1a237e;
      --primary-dark: #90caf9;
      --secondary-light: #3949ab;
      --secondary-dark: #90caf9;
      --aside-light: linear-gradient(135deg, #e3e6f0 0%, #c5cae9 100%);
      --aside-dark: linear-gradient(135deg, #23272a 0%, #283593 100%);
    }
    body {
      font-family: 'Roboto', Arial, sans-serif;
      background: var(--bg-light);
      color: var(--text-light);
      margin: 0;
      padding: 0;
    }
    body.dark-mode {
      background: var(--bg-dark);
      color: var(--text-dark);
    }
    .container {
      max-width: 900px;
      margin: 40px auto;
      background: var(--container-light);
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      border-radius: 10px;
      padding: 40px 50px;
      position: relative;
    }
    body.dark-mode .container {
      background: var(--container-dark);
    }
    .top-bar {
      position: absolute;
      top: 30px;
      right: 40px;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 10px;
      z-index: 10;
    }
    .top-buttons {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }
    .theme-toggle-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      font-size: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      position: relative;
    }
    .theme-toggle-btn svg {
      width: 28px;
      height: 28px;
      display: block;
      color: #3949ab;
      background: transparent;
    }
    .theme-toggle-btn:focus { outline: 2px solid #3949ab; }
    #icon-sun, #icon-moon { position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
    #icon-sun { display: inline-block; }
    #icon-moon { display: none; }
    body.dark-mode #icon-sun { display: none; }
    body.dark-mode #icon-moon { display: inline-block; }
    .language-switcher {
      display: flex;
      gap: 10px;
    }
    .language-flag {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.3s, border 0.3s;
      border: 2px solid transparent;
    }
    .language-flag.active {
      opacity: 1;
      border: 2px solid #1a237e;
    }
    .lang-section { 
      display: none;
      font-size: 10pt;
    }
    h1 {
      color: var(--primary-light);
      font-size: 2em;
      margin-bottom: 0.2em;
    }
    body.dark-mode h1 {
      color: var(--primary-dark);
    }
    h2 {
      color: var(--secondary-light);
      border-bottom: 2px solid #e3e6f0;
      padding-bottom: 5px;
      margin-top: 1.5em;
      margin-bottom: 0.5em;
      font-size: 1.4em;
    }
    body.dark-mode h2 {
      color: var(--secondary-dark);
      border-bottom-color: #374151;
    }
    aside h2 {
      border-bottom: 2px solid #c5cae9;
    }
    h3 {
      color: #222;
      margin-bottom: 0.2em;
      font-size: 1.1em;
    }
    body.dark-mode h3 {
      color: #f1f1f1;
    }
    .info { 
      color: #555; 
      margin-bottom: 1em;
      font-size: 0.9em;
    }
    body.dark-mode .info { color: #b0b0b0; }
    .section { margin-bottom: 1em; }
    .item-title {
      display: flex;
      align-items: baseline;
      gap: 8px;
      flex-wrap: wrap;
      color: var(--secondary-light);
      font-weight: bold;
      font-size: 1em;
    }
    body.dark-mode .item-title { color: var(--secondary-dark); }
    .dates {
      margin-left: auto;
      vertical-align: baseline;
      font-size: 0.85em !important;
      color: #78909c;
      font-style: italic;
    }
    .info span[id^="age"], .info span[id^="xp"] {
      display: inline;
      vertical-align: baseline;
      font-weight: 500;
      margin-right: 3px;
    }
    span[id^="xp"], span[id^="xp-en"] {
      display: inline;
      vertical-align: baseline;
      font-weight: 500;
      margin-right: 3px;
    }
    /* Listes : on garde l'indentation naturelle */
    .cv-flex { 
      display: flex; 
      margin-top: 1em;
      gap: 30px;
    }
    aside {
      flex-basis: 30%;
      max-width: 30%;
      min-width: 160px;
      background: var(--aside-light);
      border-radius: 16px;
      padding: 20px 15px;
      color: var(--primary-light);
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      flex-shrink: 0;
    }
    body.dark-mode aside {
      background: var(--aside-dark);
      color: var(--primary-dark);
    }
    .main-content { 
      flex-basis: 70%; 
      max-width: 70%; 
      flex-grow: 1;
    }
    .header-flex {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .header-flex img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-left: 20px;
    }
    a { color: var(--secondary-light); }
    body.dark-mode a { color: var(--secondary-dark); }
    @media (max-width: 800px) {
      .top-bar { position: static; align-items: center; }
      .top-buttons { justify-content: center; }
      .header-flex { flex-direction: column; align-items: center; text-align: center; }
      .header-flex img { margin: 20px 0 0 0; }
      .cv-flex { flex-direction: column; }
      aside, .main-content { max-width: 100% !important; flex-basis: 100% !important; }
      aside { order: 2; margin-top: 30px; }
      .language-switcher { justify-content: center; margin-bottom: 20px; }
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div class="top-buttons">
      <button id="theme-toggle" class="theme-toggle-btn" aria-label="Changer le thème" title="Changer le thème" type="button">
        <span id="icon-sun">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
        </span>
        <span id="icon-moon" style="display: none">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
        </span>
      </button>
      <button id="export-pdf" class="theme-toggle-btn" aria-label="Exporter en PDF" title="Exporter en PDF">
        <span>
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect>
            <path d="M8 2v4M16 2v4M4 10h16"></path>
          </svg>
        </span>
      </button>
    </div>
    <div class="language-switcher">
      <img src="https://flagcdn.com/fr.svg" class="language-flag" data-lang="fr" alt="Français" title="Français" crossorigin="anonymous">
      <img src="https://flagcdn.com/gb.svg" class="language-flag" data-lang="en" alt="English" title="English" crossorigin="anonymous">
    </div>
  </div>
  <div class="container">
    <!-- ... (le contenu FR/EN complet, inchangé, voir versions précédentes) ... -->
    <!-- (copie intégrale du contenu fourni dans la version précédente) -->
    <!-- ... -->
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    window.html2canvas = html2canvas;

    function calculateAge(birthDateStr) {
      const today = new Date();
      const birthDate = new Date(birthDateStr);
      let age = today.getFullYear() - birthDate.getFullYear();
      const m = today.getMonth() - birthDate.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
      }
      return age;
    }
    function calculateExperience(startDateStr) {
      const today = new Date();
      const startDate = new Date(startDateStr);
      let years = today.getFullYear() - startDate.getFullYear();
      if (
        today.getMonth() < startDate.getMonth() ||
        (today.getMonth() === startDate.getMonth() && today.getDate() < startDate.getDate())
      ) {
        years--;
      }
      return years;
    }

    function switchLanguage(lang) {
      document.getElementById('fr').style.display = lang === 'fr' ? 'block' : 'none';
      document.getElementById('en').style.display = lang === 'en' ? 'block' : 'none';
      document.querySelectorAll('.language-flag').forEach(flag => {
        flag.classList.toggle('active', flag.dataset.lang === lang);
      });
      localStorage.setItem('preferredLang', lang);
    }

    document.addEventListener('DOMContentLoaded', function () {
      // Âge dynamique
      const age = calculateAge('1977-10-20');
      const ageFrElem = document.getElementById('age');
      if (ageFrElem) ageFrElem.textContent = age;
      const ageEnElem = document.getElementById('age-en');
      if (ageEnElem) ageEnElem.textContent = age;

      // Expérience dynamique (depuis 2005)
      const xpYears = calculateExperience('2005-01-01');
      const xpElem = document.getElementById('xp');
      if (xpElem) xpElem.textContent = xpYears;
      const xpEnElem = document.getElementById('xp-en');
      if (xpEnElem) xpEnElem.textContent = xpYears;

      // Langue
      const savedLang = localStorage.getItem('preferredLang');
      let lang = 'fr';
      if (savedLang) {
        lang = savedLang;
      } else if (navigator.language && navigator.language.toLowerCase().startsWith('en')) {
        lang = 'en';
      }
      switchLanguage(lang);
      document.querySelectorAll('.language-flag').forEach((flag) => {
        flag.addEventListener('click', () => switchLanguage(flag.dataset.lang));
      });

      // THEME SWITCH
      const themeToggle = document.getElementById('theme-toggle');
      const iconSun = document.getElementById('icon-sun');
      const iconMoon = document.getElementById('icon-moon');

      function setTheme(mode) {
        if (mode === 'dark') {
          document.body.classList.add('dark-mode');
          iconSun.style.display = 'none';
          iconMoon.style.display = 'inline-block';
        } else {
          document.body.classList.remove('dark-mode');
          iconSun.style.display = 'inline-block';
          iconMoon.style.display = 'none';
        }
        localStorage.setItem('theme', mode);
      }

      themeToggle.addEventListener('click', function () {
        const isDark = document.body.classList.contains('dark-mode');
        setTheme(isDark ? 'light' : 'dark');
      });

      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        setTheme(savedTheme);
      } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        setTheme('dark');
      } else {
        setTheme('light');
      }

      // EXPORT PDF (jsPDF)
      document.getElementById('export-pdf').addEventListener('click', async function () {
        const { jsPDF } = window.jspdf;
        const langSection =
          document.querySelector('.lang-section[style*="block"]') ||
          document.querySelector('.lang-section:not([style*="none"])');
        if (!langSection) return;

        const clone = langSection.cloneNode(true);
        clone.style.width = '790px';
        clone.style.fontSize = '10pt';
        clone.style.lineHeight = '1.4';
        clone.classList.remove('dark-mode');
        clone.querySelectorAll('aside').forEach((aside) => {
          aside.style.background = '#e3e6f0';
          aside.style.color = '#1a237e';
        });
        clone.querySelectorAll('h1').forEach((el) => (el.style.color = '#1a237e'));
        clone.querySelectorAll('h2').forEach((el) => {
          el.style.color = '#3949ab';
          el.style.borderBottom = '2px solid #e3e6f0';
          el.style.paddingBottom = '5px';
        });
        clone.querySelectorAll('aside h2').forEach((el) => {
          el.style.borderBottom = '2px solid #c5cae9';
        });
        clone.querySelectorAll('.item-title').forEach((el) => (el.style.color = '#3949ab'));
        clone.querySelectorAll('a').forEach((el) => (el.style.color = '#3949ab'));
        clone.style.background = '#fff';
        clone.style.color = '#222';

        // Réinitialisation des marges/paddings SAUF listes et h2
        clone.querySelectorAll('*:not(h2):not(ul):not(ol):not(li)').forEach(el => {
          el.style.margin = '0';
          el.style.padding = '0';
          el.style.boxShadow = 'none';
          el.style.lineHeight = 'inherit';
        });

        // Correction d’alignement pour âge et expérience
        clone.querySelectorAll('span[id^="age"], span[id^="xp"], span[id^="age-en"], span[id^="xp-en"]').forEach((span) => {
          span.style.display = 'inline';
          span.style.verticalAlign = 'baseline';
          span.style.fontWeight = '500';
          span.style.marginRight = '3px';
          span.style.lineHeight = 'inherit';
          span.style.padding = '0';
        });

        // FORCAGE de la valeur du span xp/xp-en dans le clone
        const xpYears = calculateExperience('2005-01-01');
        const xpElem = clone.querySelector('#xp');
        if (xpElem) xpElem.textContent = xpYears;
        const xpEnElem = clone.querySelector('#xp-en');
        if (xpEnElem) xpEnElem.textContent = xpYears;

        // Cache-buster pour les images
        clone.querySelectorAll('img').forEach((img) => {
          if (img.src.startsWith('http')) {
            img.src = img.src + (img.src.includes('?') ? '&' : '?') + 'cache=' + Date.now();
          }
        });

        const doc = new jsPDF({
          orientation: 'portrait',
          unit: 'pt',
          format: 'a4',
        });

        await doc.html(clone, {
          margin: [30, 30, 30, 30],
          html2canvas: {
            useCORS: true,
            scale: 0.6,
            backgroundColor: '#FFFFFF',
          },
          callback: function (doc) {
            doc.save('CV_Damien_Guesdon.pdf');
          },
          autoPaging: 'text',
          width: 790,
        });
      });
    });
  </script>
</body>
</html>
